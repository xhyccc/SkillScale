# SkillScale — Docker Compose for Local Development
#
# Topology:
#   agent ──PUB──▶ proxy (XSUB:5444) ──▶ proxy (XPUB:5555) ──SUB──▶ skill-server-*
#   agent ◀──SUB── proxy (XPUB:5555) ◀──PUB── skill-server-*
#

services:
  # ── Central XPUB/XSUB Proxy ──
  proxy:
    build:
      context: .
      dockerfile: docker/Dockerfile.proxy
    ports:
      - "5444:5444"   # XSUB — publishers connect here
      - "5555:5555"   # XPUB — subscribers connect here
      - "9100:9100"   # Prometheus metrics
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "echo | nc -z localhost 5444"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ── Skill Server: data-processing topic ──
  skill-server-data:
    build:
      context: .
      dockerfile: docker/Dockerfile.skill-server
    environment:
      SKILLSCALE_TOPIC: TOPIC_DATA_PROCESSING
      SKILLSCALE_SKILLS_DIR: /skills
      SKILLSCALE_PROXY_XPUB: tcp://proxy:5555
      SKILLSCALE_PROXY_XSUB: tcp://proxy:5444
      SKILLSCALE_WORKERS: "2"
      SKILLSCALE_TIMEOUT: "30000"
    volumes:
      - ./skills/data-processing:/skills:ro
    depends_on:
      proxy:
        condition: service_healthy
    restart: unless-stopped

  # ── Skill Server: code-analysis topic ──
  skill-server-code:
    build:
      context: .
      dockerfile: docker/Dockerfile.skill-server
    environment:
      SKILLSCALE_TOPIC: TOPIC_CODE_ANALYSIS
      SKILLSCALE_SKILLS_DIR: /skills
      SKILLSCALE_PROXY_XPUB: tcp://proxy:5555
      SKILLSCALE_PROXY_XSUB: tcp://proxy:5444
      SKILLSCALE_WORKERS: "2"
      SKILLSCALE_TIMEOUT: "30000"
    volumes:
      - ./skills/code-analysis:/skills:ro
    depends_on:
      proxy:
        condition: service_healthy
    restart: unless-stopped

  # ── Python Front-End Agent ──
  agent:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent
    environment:
      SKILLSCALE_PROXY_XSUB: tcp://proxy:5444
      SKILLSCALE_PROXY_XPUB: tcp://proxy:5555
      SKILLSCALE_TIMEOUT: "30"
    depends_on:
      proxy:
        condition: service_healthy
      skill-server-data:
        condition: service_started
      skill-server-code:
        condition: service_started
    stdin_open: true
    tty: true
    restart: unless-stopped
